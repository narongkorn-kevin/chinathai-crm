<div class="flex flex-col flex-auto min-w-0">
    <div class="flex-auto sm:p-10 bg-card m-4 p-4 rounded-md">
        <form [formGroup]="form">
            <div class="flex flex-row justify-between pb-2 items-center">
                <div class="flex flex-col">
                    <div class="flex space-x-2">
                        <!-- <p
                            class="md:text-sm font-medium tracking-tight leading-7 sm:leading-10 truncate text-primary-500">
                            {{ 'order_products.order_create.title' | transloco }}
                        </p> -->
                    </div>

                    <div class="flex flex-row gap-4">
                        <!-- <p
                            class="md:text-2xl text-primary-500 font-bold tracking-tight leading-7 sm:leading-10 truncate">
                            {{ 'order_products.order_create.add_item' | transloco }}
                        </p> -->
                    </div>
                     <div class="mt-4 flex justify-center">
                <div class="inline-flex rounded-full border border-slate-200 bg-white p-1 shadow-sm">
                    <button type="button"
                        class="rounded-full px-4 py-2 text-sm font-medium transition-colors duration-150"
                        [ngClass]="activeTabIndex === 0 ? 'bg-primary-500 text-white shadow-sm' : 'text-slate-600 hover:text-primary-500'"
                        (click)="setActiveTab(0)">
                        {{ 'order_products.order_create.product_info' | transloco }}
                    </button>
                    <button type="button"
                        class="rounded-full px-4 py-2 text-sm font-medium transition-colors duration-150"
                        [ngClass]="activeTabIndex === 1 ? 'bg-primary-500 text-white shadow-sm' : 'text-slate-600 hover:text-primary-500'"
                        (click)="setActiveTab(1)">
                        {{ 'order_products.order_create.customer_info' | transloco }}
                    </button>
                </div>
            </div>
                </div>
                <div class="flex flex-col md:flex-row gap-2">
                    <button type="button" [matBadge]="cart.length" matBadgePosition="above before" mat-flat-button
                        class="!text-white" [color]="'accent'" (click)="openCart()">
                        <mat-icon class="icon-size-5" [svgIcon]="'heroicons_solid:shopping-cart'"></mat-icon>
                        <span class="ml-2"> {{ 'order_products.order_create.shopping_cart' | transloco }}</span>
                    </button>

                    <button  mat-flat-button class="!text-white" [color]="'primary'" (click)="submit()" type="button">
                        <mat-icon class="icon-size-5" [svgIcon]="'heroicons_solid:document-text'"></mat-icon>
                        <span class="ml-2"> {{ 'order_products.order_create.place_order' | transloco }}</span>
                    </button>
                </div>
            </div>

            <div class="border-b-2 w-full"></div>

           

            <div class="flex flex-col mt-4" *ngIf="activeTabIndex === 1">
                <h3 class="text-2xl font-bold">{{ 'order_products.order_create.customer_info' | transloco }}</h3>
                <div class="border-b-2 w-full my-4"></div>

                <div class="customer-info-wrapper">
                    <div class="state-block" *ngIf="memberLoading">
                        <mat-progress-spinner diameter="40" mode="indeterminate"></mat-progress-spinner>
                        <p class="state-text">กำลังโหลดข้อมูลลูกค้า...</p>
                    </div>

                    <div class="state-block error" *ngIf="!memberLoading && memberError">
                        <mat-icon svgIcon="heroicons_outline:exclamation-triangle"></mat-icon>
                        <p class="state-text">{{ memberError }}</p>
                        <button mat-flat-button color="primary" type="button" (click)="refreshMember()">ลองอีกครั้ง</button>
                    </div>

                    <ng-container *ngIf="!memberLoading && !memberError">
                        <ng-container *ngIf="memberData as data; else noMemberData">
                            <div class="customer-overview">
                                <section class="customer-card">
                                    <header>
                                        <h4>ข้อมูลลูกค้า</h4>
                                        <p>ตรวจสอบรายละเอียดบัญชีก่อนดำเนินการสั่งซื้อ</p>
                                    </header>
                                    <mat-divider></mat-divider>
                                    <dl class="customer-info-list">
                                        <div>
                                            <dt>ชื่อ - นามสกุล</dt>
                                            <dd>{{ data.fname }} {{ data.lname }}</dd>
                                        </div>
                                        <div>
                                            <dt>รหัสลูกค้า</dt>
                                            <dd>{{ data.code || '-' }}</dd>
                                        </div>
                                        <div>
                                            <dt>รหัสผู้ใช้งาน</dt>
                                            <dd>{{ data.importer_code || '-' }}</dd>
                                        </div>
                                        <div>
                                            <dt>เบอร์โทรศัพท์</dt>
                                            <dd>{{ data.phone || '-' }}</dd>
                                        </div>
                                        <div>
                                            <dt>อีเมล</dt>
                                            <dd>{{ data.email || '-' }}</dd>
                                        </div>
                                        <div>
                                            <dt>ไอดีไลน์</dt>
                                            <dd>{{ data.line_id || '-' }}</dd>
                                        </div>
                                        <div>
                                            <dt>ประเภทสมาชิก</dt>
                                            <dd>{{ data.member_type || '-' }}</dd>
                                        </div>
                                        <div>
                                            <dt>รหัสเซลล์</dt>
                                            <dd>{{ data.referrer || '-' }}</dd>
                                        </div>
                                    </dl>
                                </section>

                                <section class="customer-card order-settings">
                                    <header>
                                        <h4>การตั้งค่าคำสั่งซื้อ</h4>
                                        <p>กำหนดรูปแบบการชำระเงินและช่องทางจัดส่ง</p>
                                    </header>
                                    <mat-divider></mat-divider>
                                    <div class="order-settings__grid">
                                        <mat-form-field appearance="outline">
                                            <mat-label>{{ 'order_products.order_create.fields.payment_term' | transloco }}</mat-label>
                                            <mat-select [formControlName]="'payment_term'">
                                                <mat-option value="1">
                                                    {{ 'order_products.order_create.fields.payment_options.single' | transloco }}
                                                </mat-option>
                                                <mat-option value="2">
                                                    {{ 'order_products.order_create.fields.payment_options.multiple' | transloco }}
                                                </mat-option>
                                            </mat-select>
                                        </mat-form-field>
                                        <mat-form-field appearance="outline">
                                            <mat-label>{{ 'order_products.order_create.fields.shipping_type' | transloco }}</mat-label>
                                            <mat-select [formControlName]="'shipping_type'">
                                                <mat-option value="car">
                                                    {{ 'order_products.order_create.fields.shipping_options.car' | transloco }}
                                                </mat-option>
                                                <mat-option value="ship">
                                                    {{ 'order_products.order_create.fields.shipping_options.ship' | transloco }}
                                                </mat-option>
                                                <mat-option value="air">
                                                    {{ 'order_products.order_create.fields.shipping_options.air' | transloco }}
                                                </mat-option>
                                            </mat-select>
                                        </mat-form-field>
                                        <mat-form-field appearance="outline">
                                            <mat-label>{{ 'order_products.order_create.fields.bill_vat_type' | transloco }}</mat-label>
                                            <mat-select [formControlName]="'bill_vat'">
                                                <mat-option value="Y">
                                                    {{ 'order_products.order_create.fields.bill_vat.vat' | transloco }}
                                                </mat-option>
                                                <mat-option value="N">
                                                    {{ 'order_products.order_create.fields.bill_vat.non_vat' | transloco }}
                                                </mat-option>
                                            </mat-select>
                                        </mat-form-field>
                                    </div>
                                    <mat-form-field appearance="outline" class="mt-4">
                                        <mat-label>{{ 'order_products.order_create.fields.note' | transloco }}</mat-label>
                                        <textarea matInput rows="3" formControlName="note"></textarea>
                                    </mat-form-field>
                                </section>
                            </div>

                            <section class="customer-card shipping-section">
                                <header>
                                    <div>
                                        <h4>เลือกที่อยู่สำหรับจัดส่ง</h4>
                                        <p>คลิกเลือกที่อยู่ที่จะใช้สำหรับคำสั่งซื้อครั้งนี้</p>
                                    </div>
                                    <span class="badge-count">{{ shippingAddresses.length }}</span>
                                </header>
                                <mat-divider></mat-divider>
                                <ng-container *ngIf="shippingAddresses.length > 0; else shippingEmpty">
                                    <div class="shipping-grid">
                                        <button
                                            type="button"
                                            class="shipping-card"
                                            [class.shipping-card-selected]="isAddressSelected(address)"
                                            [class.shipping-card-default]="address.is_default"
                                            *ngFor="let address of shippingAddresses; let i = index"
                                            (click)="selectShippingAddress(address)">
                                            <div class="shipping-card__heading">
                                                <div class="icon-wrapper">
                                                    <mat-icon svgIcon="heroicons_outline:map-pin"></mat-icon>
                                                </div>
                                                <div>
                                                    <h5>
                                                        {{ address.name || ('ผู้รับ #' + (i + 1)) }}
                                                        <span *ngIf="address.is_default" class="default-pill">ที่อยู่หลัก</span>
                                                    </h5>
                                                    <p class="shipping-phone">{{ address.phone || '-' }}</p>
                                                </div>
                                            </div>
                                            <p class="shipping-address">
                                                {{ address.address || '-' }}<br>
                                                {{ address.sub_district || '-' }} {{ address.district || '-' }}<br>
                                                {{ address.province || '-' }} {{ address.postal_code || '-' }}
                                            </p>
                                        </button>
                                    </div>
                                </ng-container>
                            </section>
                        </ng-container>
                    </ng-container>

                    <ng-template #noMemberData>
                        <div class="state-block error">
                            <mat-icon svgIcon="heroicons_outline:user-circle"></mat-icon>
                            <p class="state-text">ยังไม่พบข้อมูลลูกค้า</p>
                            <button mat-flat-button color="primary" type="button" (click)="refreshMember()">ลองโหลดข้อมูลอีกครั้ง</button>
                        </div>
                    </ng-template>

                    <ng-template #shippingEmpty>
                        <div class="empty-shipping">
                            <mat-icon svgIcon="heroicons_outline:building-storefront"></mat-icon>
                            <p>ยังไม่มีการบันทึกที่อยู่จัดส่ง กรุณาติดต่อทีมงานเพื่ออัปเดตข้อมูล</p>
                        </div>
                    </ng-template>
                </div>
            </div>

            <div class="flex flex-col mt-4" *ngIf="activeTabIndex === 0">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-bold">{{ 'order_products.order_create.product_info' | transloco }}</h3>
                    <button type="button" mat-flat-button class="!text-white" [color]="'primary'"
                        (click)="openDialogNewProduct()">
                        <mat-icon class="icon-size-5" [svgIcon]="'heroicons_solid:plus'"></mat-icon>
                        <span class="ml-2"> {{ 'order_products.order_create.add_product' | transloco }}</span>
                    </button>
                </div>
                <div class="border-b-2 w-full my-4"></div>
                <div class="flex flex-col md:flex-row items-center gap-2">
                    <mat-form-field [ngClass]="formFieldHelpers" class="w-full">
                        <mat-label>{{ 'order_products.order_create.search_product' | transloco }}</mat-label>
                        <input matInput [formControl]="search" placeholder="ค้นหาจากชื่อสินค้าหรือ URL" (keydown.enter)="clickSearchProduct()">
                    </mat-form-field>

                    <mat-form-field class="w-full md:w-40" [ngClass]="formFieldHelpers">
                        <mat-label>{{ 'order_products.order_create.fields.service' | transloco }}</mat-label>
                        <mat-select [(value)]="selectedService">
                            <mat-option value="1688">{{ 'order_products.order_create.fields.service_options.1688' |
                                transloco
                                }}</mat-option>
                            <mat-option value="taobao">{{ 'order_products.order_create.fields.service_options.taobao' |
                                transloco
                                }}</mat-option>
                        </mat-select>
                    </mat-form-field>

                    <button type="button" mat-flat-button class="!text-white" [color]="'primary'"
                        (click)="clickSearchProduct()">
                        <mat-icon class="icon-size-5" [svgIcon]="'heroicons_solid:magnifying-glass'"></mat-icon>
                        <span class="ml-2"> {{ 'ค้นหา' | transloco }}</span>
                    </button>
                </div>

                <div class="mt-6 w-full">
                    <ng-container *ngIf="products?.length; else noProducts">
                        <div class="grid gap-4 sm:grid-cols-4 2xl:grid-cols-4">
                            <div *ngFor="let element of products"
                                class="flex h-full flex-col overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm transition-all hover:shadow-md">
                                <div class="relative h-52 w-full bg-slate-100">
                                    <img *ngIf="element.pic_url && !element.imageError" [src]="element.pic_url"
                                        alt="Product Image" class="h-full w-full object-cover"
                                        (error)="onImageError(element)">
                                    <div *ngIf="!element.pic_url || element.imageError"
                                        class="flex h-full w-full items-center justify-center bg-slate-100">
                                        <mat-icon class="text-5xl text-slate-300"
                                            [svgIcon]="'heroicons_outline:photo'"></mat-icon>
                                    </div>
                                </div>
                                <div class="flex flex-1 flex-col p-4">
                                    <div>
                                        <p class="text-base font-semibold text-gray-900 line-clamp-2">
                                            {{ element?.title }}
                                        </p>
                                        <p class="mt-1 text-xs text-slate-500 line-clamp-2">
                                            {{ element?.title | translateText:'zh-CN':'th' | async }}
                                        </p>
                                    </div>
                                    <div class="mt-3 flex items-center justify-between">
                                        <span class="text-lg font-semibold text-primary-500">
                                            ¥ {{ element.price | number:'1.2-2' }}
                                        </span>
                                    </div>
                                    <div class="mt-4 flex flex-col gap-2">
                                        <a *ngIf="element.detail_url" [href]="element.detail_url" target="_blank"
                                            rel="noopener"
                                            class="inline-flex items-center justify-center rounded-lg border border-primary-200 px-3 py-2 text-sm font-medium text-primary-500 hover:bg-primary-50">
                                            {{ 'order_products.order_create.product_table.view' | transloco }}
                                        </a>
                                        <button type="button" mat-flat-button color="primary"
                                            (click)="viewDetail(element.num_iid)">
                                            {{ 'order_products.order_create.product_table.view_details' | transloco }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </ng-container>
                    <ng-template #noProducts>
                        <div class="flex flex-col items-center justify-center rounded-2xl border border-dashed border-slate-200 bg-slate-50 py-12 text-center">
                            <mat-icon class="mb-2 text-3xl text-slate-400"
                                [svgIcon]="'heroicons_outline:information-circle'"></mat-icon>
                            <p class="text-sm font-medium text-slate-500">ไม่พบรายการสินค้า</p>
                        </div>
                    </ng-template>
                </div>

                <mat-paginator class="mt-6 rounded-xl border border-slate-200 bg-white"
                    [length]="totalItems" [pageSize]="20" showFirstLastButtons></mat-paginator>
            </div>
        </form>
    </div>
</div>

<ng-template #pic let-data="adtData">
    <div class="flex flex-row justify-center">
        <img [src]="data?.product_image" alt="Image" class="rounded-md w-20 text-center" />
    </div>
</ng-template>

<fuse-drawer class="w-screen min-w-screen sm:w-100 sm:min-w-100 z-999" fixed [mode]="'over'" [name]="'settingsDrawer'"
    [position]="'right'" [(opened)]="drawerOpened" #settingsDrawer>

    <div class="flex flex-col w-full overflow-auto bg-card">
        <div class="flex flex-row items-center px-6 h-20 min-h-20 text-white bg-primary">
            <mat-icon class="icon-size-7 text-current" [svgIcon]="'heroicons_solid:cog-8-tooth'"></mat-icon>
            <div class="ml-3 text-2xl font-semibold tracking-tight">
                {{ 'order_products.order_create.cart.title' | transloco }}
            </div>
            <button type="button" class="ml-auto" mat-icon-button (click)="drawerOpened = false">
                <mat-icon class="text-current" [svgIcon]="'heroicons_outline:x-mark'"></mat-icon>
            </button>
        </div>

        <div class="flex flex-col p-6">
            @for (item of cart; track $index) {
            <div class="flex flex-col w-full">
                <div class="flex justify-end mb-2">
                    <button type="button" mat-stroked-button [color]="'warn'" (click)="removeFromCart(item)">
                        <span class=""> {{ 'buttons.delete' | transloco }}</span>
                    </button>
                </div>
                <div class="flex flex-row gap-5 mb-4">
                    <div
                        class="w-20 h-20 relative rounded-lg overflow-hidden flex items-center justify-center bg-gray-100 text-gray-400">
                        <!-- ถ้าไม่มีรูป -->
                        <ng-container *ngIf="!item?.product_image || item.imageError; else hasImage">
                            <span class="text-xs">No image</span>
                        </ng-container>

                        <!-- ถ้ามีรูป -->
                        <ng-template #hasImage>
                            <img class="w-full h-full object-cover" [src]="item?.product_image" alt="Image"
                                (error)="onImageError(item)" />
                        </ng-template>
                    </div>

                    <div class="flex flex-col w-3/4">
                        <div class="flex">{{item?.product_name}}</div>
                        <div class="flex flex-row justify-around items-center">
                            <button type="button" class="" mat-icon-button (click)="decreaseQuantity(item)">
                                <mat-icon svgIcon="heroicons_outline:minus-small"></mat-icon>
                            </button>
                            <mat-label>{{ item?.product_qty}}</mat-label>
                            <button type="button" class="" mat-icon-button (click)="increaseQuantity(item)">
                                <mat-icon svgIcon="heroicons_outline:plus-small"></mat-icon>
                            </button>
                        </div>
                    </div>
                </div>
                <mat-divider></mat-divider>
            </div>
            }
        </div>
    </div>
</fuse-drawer>
